{
  "body": "Ensure that no SQL Databases allow ingress from 0.0.0.0/0 (ANY IP).\n\n### Rationale\n\nAzure SQL Server includes a firewall to block access to unauthorized connections. The range of IP addresses available from specific data centers can be used to define more granular IP addresses.\n\nBy default, for a SQL server, a Firewall exists with StartIp of 0.0.0.0 and EndIP of 0.0.0.0 allowing access to all Azure services.\n\nAdditionally, a custom rule can be set up with StartIp of 0.0.0.0 and EndIP of 255.255.255.255, allowing access from ANY IP over the Internet.\n\nTo reduce a SQL server's potential attack surface, firewall rules should be defined with more granular IP addresses, referencing the range of addresses available from specific data centers.\n\nIf `Allow Azure services and resources to access this server` is 'Checked', this will allow resources outside of the subscription/tenant/organization boundary, within any region of Azure, to effectively bypass the defined SQL Server Network ACL on the public endpoint. A malicious attacker can successfully launch a SQL server password bruteforce attack by creating a virtual machine in any Azure subscription/region from outside the subscription boundary where the SQL Server resides.\n\n### Impact\n\nDisabling `Allow Azure services and resources to access this server` will break all connections to SQL server and Hosted Databases unless custom IP-specific rules are added to the Firewall Policy.\n\n### Default Value\n\nBy default, the setting `Allow Azure services and resources to access this server` is set to `ON`.\n\n### Additional Information\n\nFirewall rules configured on individual SQL Database using Transact-SQL overrides the rules set on SQL server. Azure does not provide any Powershell, API, CLI, or Portal option to check database-level firewall rules, and so far, Transact-SQL is the only way to check for them. For comprehensive control over egress traffic on SQL Databases, Firewall rules should be checked using SQL client.\n\n### References\n\n1. [https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access?view=sql-server-2017](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access?view=sql-server-2017)\n2. [https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/get-azurermsqlserverfirewallrule?view=azurermps-5.2.0](https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/get-azurermsqlserverfirewallrule?view=azurermps-5.2.0)\n3. [https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/set-azurermsqlserverfirewallrule?view=azurermps-5.2.0](https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/set-azurermsqlserverfirewallrule?view=azurermps-5.2.0)\n4. [https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/remove-azurermsqlserverfirewallrule?view=azurermps-5.2.0](https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/remove-azurermsqlserverfirewallrule?view=azurermps-5.2.0)\n5. [https://docs.microsoft.com/en-us/azure/sql-database/sql-database-firewall-configure]https://docs.microsoft.com/en-us/azure/sql-database/sql-database-firewall-configure()\n6. [https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-set-database-firewall-rule-azure-sql-database?view=azuresqldb-current](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-set-database-firewall-rule-azure-sql-database?view=azuresqldb-current)\n7. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-network-security#ns-2-secure-cloud-services-with-network-controls](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-network-security#ns-2-secure-cloud-services-with-network-controls)",
  "name": "Ensure no Azure SQL Databases allow ingress from 0.0.0.0/0 (ANY IP)",
  "slug": "azure-sql-db-disallow-any-ip",
  "isInsight": false,
  "alertForSecondaryOnly": false,
  "rules": [
    {
      "cloudProviders": [
        "azure"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "SQLServer"
      ],
      "query": "azure-1-3-0-networking-3-no-azure-sql-databases-allow-ingress-from-0-0-0-00-any-ip",
      "isManual": false
    }
  ],
  "remediationDescription": "### From Azure Console\n\n1. Open the SQL server using the `Open in Azure` button\n2. Under `Security`, click `Networking`\n3. Uncheck `Allow Azure services and resources to access this server`\n4. Set firewall rules to limit access to authorized connections\n5. Save\n\n### Using Azure CLI\n\nDisable default firewall rule `Allow Azure services and resources to access this server`:\n\n```bash\naz sql server firewall-rule delete --resource-group <resourceGroup> --server <sqlServerName> --name \"AllowAllWindowsAzureIps\"\n```\n\nRemove a custom firewall rule:\n\n```bash\naz sql server firewall-rule delete --resource-group <resourceGroup> --server <sqlServerName> --name <firewallRuleName>\n```\n\nCreate an appropriate firewall rule, with the start IP address other than 0.0.0.0 and end IP address other than 0.0.0.0 or 255.255.255.255\n\n```bash\naz sql server firewall-rule create --resource-group <resourceGroup> --server <sqlServerName> --name <firewallRuleName> --start-ip-address \"<startIPAddress>\" --end-ip-address \"<endIPAddress>\"\n```\n\nUpdate a firewall rule\n\n```bash\naz sql server firewall-rule update --resource-group <resourceGroup> --server <sqlServerNamee> --name <firewallRuleName> --start-ip-address \"<startIPAddress>\" --end-ip-address \"<endIPAddress>\"\n```\n\n### Using Azure PowerShell\n\nDisable default firewall rule `Allow Azure services and resources to access this server`:\n\n```powershell\nRemove-AzureRmSqlServerFirewallRule -FirewallRuleName \"AllowAllWindowsAzureIps\" -ResourceGroupName <resourceGroupName> -ServerName <serverName>\n```\n\nRemove a custom firewall rule:\n\n```powershell\nRemove-AzureRmSqlServerFirewallRule -FirewallRuleName \"<firewallRuleName>\" -ResourceGroupName <resourceGroupName> -ServerName <serverName>\n```\n\nCreate an appropriate firewall rule, with the start IP address other than 0.0.0.0 and end IP address other than 0.0.0.0 or 255.255.255.255\n\n```powershell\nSet-AzureRmSqlServerFirewallRule -ResourceGroupName <resourceGroupName> -ServerName <serverName> -FirewallRuleName \"<firewallRuleName>\" -StartIpAddress \"<startIPAddress>\" -EndIpAddress \"<endIPAddress>\"\n```",
  "isEnabled": true,
  "severity": 3
}
