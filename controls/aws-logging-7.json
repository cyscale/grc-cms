{
  "name": "Ensure CloudTrail logs are encrypted with CMK",
  "slug": "aws-logging-7",
  "body": "AWS CloudTrail is a web service that records AWS API calls for an account and makes those logs available to users and resources in accordance with IAM policies. AWS Key Management Service (KMS) is a managed service that helps create and control the encryption keys used to encrypt account data, and uses Hardware Security Modules (HSMs) to protect the security of encryption keys. CloudTrail logs can be configured to leverage server side encryption (SSE) and KMS customer created master keys (CMK) to further protect CloudTrail logs. It is recommended that CloudTrail be configured to use SSE-KMS.\n\n**Rationale**\n\nConfiguring CloudTrail to use SSE-KMS provides additional confidentiality controls on log data as a given user must have S3 read permission on the corresponding log bucket and must be granted decrypt permission by the CMK policy.",
  "description": "CloudTrail Logs with default encryption",
  "severity": 1,
  "remediationDescription": "Perform the following to configure CloudTrail to use SSE-KMS: \n\n**Via the Management Console**\n\n1. Sign in to the AWS Management Console and open the CloudTrail console at\nhttps://console.aws.amazon.com/cloudtrail\n2. In the left navigation pane, choose `Trails` .\n3. Click on a Trail\n4. Under the `S3` section click on the edit button (pencil icon)\n5. Click `Advanced`\n6. Select an existing CMK from the `KMS key Id` drop-down menu\n* Note: Ensure the CMK is located in the same region as the S3 bucket\n* Note: You will need to apply a KMS Key policy on the selected CMK in order for\nCloudTrail as a service to encrypt and decrypt log files using the CMK provided. Steps are provided [here](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/create-kms-key-policy-for-cloudtrail.html) for editing the selected CMK Key policy\n7. Click `Save`\n8. You will see a notification message stating that you need to have decrypt\npermissions on the specified KMS key to decrypt log files.\n9. Click `Yes`\n\n**Via CLI**\n\n```bash\naws cloudtrail update-trail --name <trail_name> --kms-id <cloudtrail_kms_key>\naws kms put-key-policy --key-id <cloudtrail_kms_key> --policy <cloudtrail_kms_key_policy>\n```\n\n**Impact**\n\nCustomer created keys incur an additional cost. See https://aws.amazon.com/kms/pricing/ for more information.\n\n**References**\n\n1. CIS CSC v6.0 #13.1: Perform an assessment of data to identify sensitive information.\n2. https://docs.aws.amazon.com/awscloudtrail/latest/userguide/encrypting-cloudtrail-log-files-with-aws-kms.html\n3. http://docs.aws.amazon.com/kms/latest/developerguide/create-keys.html\n4. CIS CSC v6.0 #6: Maintenance, Monitoring, and Analysis of Audit Logs\n5. CCE-78919-8\n\n**Notes**\n\n3 statements which need to be added to the CMK policy: \n\n1. Enable Cloudtrail to describe CMK properties\n\njson```json\n{ \"Sid\": \"Allow CloudTrail access\",\n\"Effect\": \"Allow\",\n\"Principal\": {\n\"Service\": \"cloudtrail.amazonaws.com\" },\n  \"Action\": \"kms:DescribeKey\",\n  \"Resource\": \"*\"\n}\n```\n\n2. Granting encrypt permissions\n\n```json\n{ \"Sid\": \"Allow CloudTrail to encrypt logs\",\n\"Effect\": \"Allow\",\n\"Principal\": {\n\"Service\": \"cloudtrail.amazonaws.com\" },\n  \"Action\": \"kms:GenerateDataKey*\",\n  \"Resource\": \"*\",\n  \"Condition\": {\n\"StringLike\": { \"kms:EncryptionContext:aws:cloudtrail:arn\": [\n\"arn:aws:cloudtrail:*:aws-account-id:trail/*\" ]\n} }\n}\n```\n\n3. Granting decrypt permissions\n\n```json\n{ \"Sid\": \"Enable CloudTrail log decrypt permissions\", \"Effect\": \"Allow\",\n\"Principal\": {\n\"AWS\": \"arn:aws:iam::aws-account-id:user/username\" },\n\"Action\": \"kms:Decrypt\",\n  \"Resource\": \"*\",\n  \"Condition\": {\n\"Null\": {\n\"kms:EncryptionContext:aws:cloudtrail:arn\": \"false\"\n} }\n}\n```",
  "rules": [
    {
      "cloudProviders": [
        "aws"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "Trail"
      ],
      "query": "aws-logging-7-cloudtrail-logs-are-encrypted-at-rest",
      "returnPath": ""
    }
  ]
}