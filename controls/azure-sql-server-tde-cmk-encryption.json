{
  "body": "Transparent Data Encryption (TDE) with Customer-managed key support provides increased transparency and control over the TDE Protector, increased security with an HSM-backed external service, and promotion of separation of duties. \n\nWith TDE, data is encrypted at rest with a symmetric key (called the database encryption key) stored in the database or data warehouse distribution. Only a certificate that the Azure SQL Service managed could be used to protect this data encryption key (DEK) in the past. With Customer-managed key support for TDE, the DEK can be protected with an asymmetric key stored in the Azure Key Vault. The Azure Key Vault is a highly available and scalable cloud-based key store that offers central key management, leverages FIPS 140-2 Level 2 validated hardware security modules (HSMs), and allows separation of management of keys and data for additional security.\n\nBased on business needs or the criticality of data/databases hosted on an SQL server, it is recommended that the TDE protector be encrypted by a key managed by the data owner (Customer-managed key).\n\n### Rationale\n\nCustomer-managed key support for Transparent DataEncryption (TDE) allows user control of TDE encryption keys and restricts who can access them and when. Azure Key Vault, Azure's cloud-based external key management system is the first key management service where TDE has integrated support for Customer-managed keys. With Customer-managed key support, the database encryption key is protected by an asymmetric key stored in the Key Vault. The asymmetric key is set at the server level and inherited by all the databases under that server.\n\n### Impact\n\nOnce TDE protector is encrypted with a Customer-managed key, it transfers the entire responsibility of key management on to the user, hence the user should be careful about doing any operations on the particular key in order to keep data from corresponding SQL server and Databases hosted accessible.\n\nWhen deploying Customer-Managed Keys, it is also prudent to ensure that an automated toolset for managing these keys is deployed (this should include discovery and key rotation). Keys should be stored in an HSM or hardware-backed keystore such as Azure Keyvault.\n\nCheck with your cryptographic key provider for toolsets. They may well offer one as an add-on to their service.",
  "name": "Ensure SQL server's TDE protector is encrypted with Customer Managed Keys (CMK)",
  "slug": "azure-sql-server-tde-cmk-encryption",
  "isInsight": false,
  "alertForSecondaryOnly": false,
  "rules": [
    {
      "cloudProviders": [
        "azure"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "SQLServer"
      ],
      "query": "azure-sql-servers-without-tde-cmk",
      "isManual": false
    }
  ],
  "remediationDescription": "\n### From Azure Console\n\n1. Open the SQL server using the `Open in Azure` button\n2. Under `Security`, click `Transparent data encryption`\n3. Select `Customer-managed key`\n4. Click `Select a key` and `Change key` to browse through existing keys or `Enter a key identifier`\n5. After filling in all the necessary information, check `Make this key the default TDE protector`\n6. Select `Save`\n\n### Using Azure CLI\n\nUse the below command to encrypt the SQL server's TDE protector with a Customer-managed key:\n\n```bash\naz sql server tde-key set --resource-group <resourceName> --server <dbServerName> --server-key-type AzureKeyVault --kid '<keyIdentifier>'\n```\n\n### Using Azure PowerShell\n\nUse the below command to encrypt the SQL server's TDE protector with a Customer-managed key vault key:\n\n```powershell\nSet-AzSqlServerTransparentDataEncryptionProtector -Type AzureKeyVault -KeyId '<keyIdentifier>' -ServerName <ServerName> -ResourceGroupName <resourceGroup>\n```\n\nSelect `Y` when prompted.\n\n### Default Value\n\nBy default, a Microsoft-managed TDE protector is enabled for an SQL server.\n\n### References\n\n1. [https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/transparent-data-encryption-byok-azure-sql](https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/transparent-data-encryption-byok-azure-sql)\n2. [https://azure.microsoft.com/en-in/blog/preview-sql-transparent-data-encryption-tde-with-bring-your-own-key-support/](https://azure.microsoft.com/en-in/blog/preview-sql-transparent-data-encryption-tde-with-bring-your-own-key-support/)\n3. [https://winterdom.com/2017/09/07/azure-sql-tde-protector-keyvault](https://winterdom.com/2017/09/07/azure-sql-tde-protector-keyvault)\n4. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-data-protection#dp-5-use-customer-managed-key-option-in-data-at-rest-encryption-when-required](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-data-protection#dp-5-use-customer-managed-key-option-in-data-at-rest-encryption-when-required)\n5. [https://docs.microsoft.com/en-us/azure/key-vault/general/basic-concepts](https://docs.microsoft.com/en-us/azure/key-vault/general/basic-concepts)\n6. [https://docs.microsoft.com/en-us/cli/azure/sql/server/tde-key?view=azure-cli-latest](https://docs.microsoft.com/en-us/cli/azure/sql/server/tde-key?view=azure-cli-latest)\n7. [https://learn.microsoft.com/en-us/powershell/module/az.sql/get-azsqlservertransparentdataencryptionprotector?view=azps-9.2.0](https://learn.microsoft.com/en-us/powershell/module/az.sql/get-azsqlservertransparentdataencryptionprotector?view=azps-9.2.0)\n8. [https://learn.microsoft.com/en-us/powershell/module/az.sql/set-azsqlservertransparentdataencryptionprotector?view=azps-9.2.0](https://learn.microsoft.com/en-us/powershell/module/az.sql/set-azsqlservertransparentdataencryptionprotector?view=azps-9.2.0)\n\n### Additional Information\n\n- This configuration is audited or can be done only on an SQL server. The same configuration will affect SQL Databases hosted on SQL Server.\nEnsuring TDE is protected by a customer-managed key on SQL Server does not ensure the encryption of SQL Databases. The `Transparent Data Encryption: Data Encryption (ON/OFF)` setting on each SQL Database decides whether the database is encrypted or not.",
  "isEnabled": true,
  "severity": 1
}
