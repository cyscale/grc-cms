{
  "name": "Ensure that logging for Azure Key Vault is 'Enabled'",
  "slug": "azure-key-vault-logging-enabled",
  "body": "Enable AuditEvent logging for key vault instances to ensure interactions with key vaults are logged and available.\n\n**Rationale**\n\nMonitoring how and when key vaults are accessed, and by whom, enables an audit trail of interactions with confidential information, keys and certificates managed by Azure Key vault. Enabling logging for Key Vault saves information in an Azure storage account that the user provides. This creates a new container named insights-logs-auditevent automatically for the specified storage account, and this same storage account can be used for collecting logs for multiple key vaults.",
  "severity": 3,
  "remediationDescription": "**From Azure Console**\n\n1. Go to `Key vaults`\n2. For each key vault, under `Monitoring`, select `Diagnostic settings`\n3. Select `Add diagnostic setting` to add a new setting or `Edit setting` to modify an existing one\n4. If you are adding a new setting, provide a name for it\n5. Under `Logs`, for `Categories`, check the `Audit Logs` checkbox\n6. Select an appropriate value for `Retention (days)` - at least 90 or 0 for infinite\n7. Under `Destination details`, select a location for your diagnostic setting\n8. Select `Save`\n\n**From Azure CLI**\n\nTo update an existing Diagnostic Setting\n\n```bash\naz monitor diagnostic-settings update --name \"<diagnosticsSettingName>\" -- resource <keyVaultResourceID> --set retentionPolicy.days=90\n```\n\nTo create a new Diagnostic Setting\n\n```bash\naz monitor diagnostic-settings create --name <diagnosticsSettingName> --resource <keyVaultResourceID> --logs \"[{category:AuditEvents,enabled:true,retentionpolicy:{enabled:true,days:180}}]\" --metrics \"[{category:AllMetrics,enabled:true,retentionpolicy:{enabled:true,days:180}}]\" <[--event-hub <eventHubID> --event-hubrule <eventHubAuthRuleID> | --storage-account <storageAccountID> |--workspace <logAnalyticsWorkspace ID> | --marketplace-partner-id <fullResourceID>]>\n```\n\n**From Azure PowerShell**\n\nCreate the `Log` settings object\n\n```powershell\n$logSettings = @()\n$logSettings += New-AzDiagnosticSettingLogSettingsObject -Enabled $true -RetentionPolicyDay 180 -RetentionPolicyEnabled $true -Category AuditEvent\n```\n\nCreate the `Metric` settings object\n\n```powershell\n$metricSettings = @()\n$metricSettings += New-AzDiagnosticSettingMetricSettingsObject -Enabled $true -RetentionPolicyDay 180 -RetentionPolicyEnabled $true -Category AllMetrics\n```\n\nCreate the `Diagnostic Settings` for each `Key Vault`\n\n```powershell\nNew-AzDiagnosticSetting -Name \"<diagnosticSettingName>\" -ResourceId <keyVaultResourceID> -Log $logSettings -Metric $metricSettings [-StorageAccountId <storageAccountID> | -EventHubName <eventHubName> -EventHubAuthorizationRuleId <eventHubAuthRuleID> | -WorkSpaceId <lognAalyticsWorkspaceID> |  -MarketPlacePartnerId <fullResourceID>]\n```\n\n\n**Default Value**\n\nBy default, Diagnostic AuditEvent logging is not enabled for Key Vault instances.\n\n**References**\n\n1. [https://docs.microsoft.com/en-us/azure/key-vault/general/howto-logging](https://docs.microsoft.com/en-us/azure/key-vault/general/howto-logging)\n2. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-data-protection#dp-8-ensure-security-of-key-and-certificate-repository](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-data-protection#dp-8-ensure-security-of-key-and-certificate-repository)\n3. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-3-enable-logging-for-security-investigation](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-3-enable-logging-for-security-investigation)",
  "rules": [
    {
      "cloudProviders": [
        "azure"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "KMSVault"
      ],
      "query": "azure-1-3-0-logging-1-5-logging-for-azure-keyvault-is-enabled"
    }
  ]
}