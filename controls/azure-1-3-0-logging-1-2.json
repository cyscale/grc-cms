{"name":"Ensure Diagnostic Setting captures appropriate categories","slug":"azure-1-3-0-logging-1-2","body":"The diagnostic setting should be configured to log the appropriate activities from the control/management plane.\n\n**Rationale**\n\nA diagnostic setting controls how the diagnostic log is exported. Capturing the diagnostic setting categories for appropriate control/management plane activities allows properalerting.","description":"","severity":1,"remediationDescription":"**From Azure Console**\n\n1. Go to `Azure Monitor`\n2. Click on `Activity log`\n3.Click on Export Activity Logs\n4. Click Edit setting on the appropriate Diagnostic setting entry\n5. Ensure that the following categories are checked: `Administrative, Alert, Policy, and Security`\n\n**Using ARM Template via AZ PowerShell cmdlets**\n\nCreate a file to hold the JSON\n\n\u003e`{\"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\"contentVersion\": \"1.0.0.0\",\"parameters\": {\"settingName\": {\"type\": \"String\"},\"workspaceId\": {\"type\": \"String\"}},\"resources\": [{\"type\": \"Microsoft.Insights/diagnosticSettings\",\"apiVersion\": \"2017-05-01-preview\",\"name\": \"[parameters('settingName')]\",\"dependsOn\": [],\"properties\": {\"workspaceId\": \"[parameters('workspaceId')]\",\"logs\": [{\"category\": \"Administrative\",\"enabled\": true},{\"category\": \"Alert\",\"enabled\": true},{\"category\": \"Autoscale\",\"enabled\": false},{\"category\": \"Policy\",\"enabled\": true},{\"category\": \"Recommendation\",\"enabled\": false},{\"category\": \"ResourceHealth\",\"enabled\": false},{\"category\": \"Security\",\"enabled\": true},{\"category\": \"ServiceHealth\",\"enabled\": false}]}}]}`\n\nReference the JSON in the New-AzSubscriptionDeployment call\n\n\u003e`$OMSWorkspace = Get-AzResource  -ResourceType \"Microsoft.OperationalInsights/workspaces\" -Name  \u003cWorkspace Name\u003eNew-AzSubscriptionDeployment -Name CreateDiagnosticSetting -location eastus -TemplateFile CreateDiagnosticSetting.jsonc -settingName \"Send Activity log to workspace\" -workspaceId $OMSWorkspace.ResourceId`\n\n**Default Value**\n\nWhen the diagnostic setting is created using Azure Portal, by default no categories are selected.\n\n**References**\n\n1. [https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostic-settings](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostic-settings)\n2. [https://docs.microsoft.com/en-us/azure/azure-monitor/samples/resource-manager-diagnostic-settings](https://docs.microsoft.com/en-us/azure/azure-monitor/samples/resource-manager-diagnostic-settings)\n3. [https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-logging-threat-detection#lt-4-enable-logging-for-azure-resources](https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-logging-threat-detection#lt-4-enable-logging-for-azure-resources)","rules":[{"cloudProviders":["azure"],"comparator":"eq","expectedResult":"[]","subjects":["SubscriptionDiagnosticSettings"],"query":"azure-1-3-0-logging-1-2-diagnostic-setting-captures-appropriate-categories","returnPath":""}]}