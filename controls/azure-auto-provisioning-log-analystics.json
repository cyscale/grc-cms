{
  "body": "Enable automatic provisioning of the monitoring agent to collect security data.\n\n**DEPRECATION PLANNED:** The Log Analytics Agent is slated for deprecation in August 2024. The Microsoft Defender for Endpoint agent, in tandem with new agentless capabilities, will provide replacement functionality. More detail is available here: [https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/microsoft-defender-for-cloud-strategy-and-plan-towards-log/ba-p/3883341](https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/microsoft-defender-for-cloud-strategy-and-plan-towards-log/ba-p/3883341).\n\n### Rationale\n\nWhen `Log Analytics agent for Azure VMs` is turned on, Microsoft Defender for Cloud provisions the Microsoft Monitoring Agent on all existing supported Azure virtual machines and any new ones created. The Microsoft Monitoring Agent scans for various security-related configurations and events, such as system updates, OS vulnerabilities, and endpoint protection, and provides alerts.\n\n**Default Value**\n\nBy default, `Automatic provisioning of monitoring agent` is set to `On`.",
  "name": "[Deprecated] Ensure Auto provisioning of 'Log Analytics agent for Azure VMs' is Set to 'On'",
  "slug": "azure-auto-provisioning-log-analystics",
  "isInsight": false,
  "alertForSecondaryOnly": false,
  "rules": [],
  "remediationDescription": "**From Azure Console**\n\n1. Go to `Microsoft Defender for Cloud`\n2. Under `Management`, select `Environment Settings`\n3. Select a subscription\n4. Select `Settings & monitoring`\n6. Set `Log Analytics agent/Azure Monitor Agent` to `On`\n\nRepeat the above for any additional subscriptions.\n\n**Using Azure Command Line Interface**\n\nUse the below command to set `Automatic provisioning of monitoring agent` to `On`.\n\n```bash\naz account get-access-token --query \"{subscription:subscription,accessToken:accessToken}\" --out tsv | xargs -L1 bash -c 'curl -X PUT -H \"Authorization: Bearer $1\" -H \"Content-Type: application/json\" https://management.azure.com/subscriptions/subscriptionID/providers/Microsoft.Security/autoProvisioningSettings/default?api-version=2017-08-01-preview -d@\"input.json\"'\n```\n\nWhere `input.json` contains the Request body json data as mentioned below.\n\n```json\n{\n    \"id\": \"/subscriptions/<subscriptionID>/providers/Microsoft.Security/autoProvisioningSettings/default\",\n    \"name\": \"default\",\n    \"type\": \"Microsoft.Security/autoProvisioningSettings\",\n    \"properties\": {\n        \"autoProvision\": \"On\"\n    }\n}\n```\n\n### Additional Information\n\n- Excluding any of the entries in `input.json` may disable the specific setting by default\n- Microsoft has recently changed APIs to get and Update Automatic Provisioning Settings. This recommendation is updated accordingly.\n\n**References**\n\n1. [https://docs.microsoft.com/en-us/azure/security-center/security-center-data-security](https://docs.microsoft.com/en-us/azure/security-center/security-center-data-security)\n2. [https://docs.microsoft.com/en-us/azure/security-center/security-center-enable-data-collection](https://docs.microsoft.com/en-us/azure/security-center/security-center-enable-data-collection)\n3. [https://msdn.microsoft.com/en-us/library/mt704062.aspx](https://msdn.microsoft.com/en-us/library/mt704062.aspx)\n4. [https://msdn.microsoft.com/en-us/library/mt704063.aspx](https://msdn.microsoft.com/en-us/library/mt704063.aspx)\n5. [https://docs.microsoft.com/en-us/rest/api/securitycenter/autoprovisioningsettings/list](https://docs.microsoft.com/en-us/rest/api/securitycenter/autoprovisioningsettings/list)\n6. [https://docs.microsoft.com/en-us/rest/api/securitycenter/autoprovisioningsettings/create](https://docs.microsoft.com/en-us/rest/api/securitycenter/autoprovisioningsettings/create)\n7. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-5-centralize-security-log-management-and-analysis](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-5-centralize-security-log-management-and-analysis)\n8. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-3-enable-logging-for-security-investigation](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-3-enable-logging-for-security-investigation)\n9. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-incident-response#ir-2-preparation--setup-incident-notification](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-incident-response#ir-2-preparation--setup-incident-notification)\n",
  "isEnabled": true,
  "severity": 1
}
