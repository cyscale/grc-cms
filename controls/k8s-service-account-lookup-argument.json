{
  "alertForSecondaryOnly": false,
  "isInsight": false,
  "name": "Ensure the --service-account-lookup argument is set to true",
  "slug": "k8s-service-account-lookup-argument",
  "body": "Validate the service account before validating the token.\n\n**Rationale**\n\nIf `--service-account-lookup` is not enabled, the API server only verifies that the authentication token is valid, and does not validate that the service account token mentioned in the request is actually present in etcd. This allows using a service account token even after the corresponding service account is deleted. This is an example of a time-of-check to time-of-use security issue.",
  "severity": 3,
  "remediationDescription": "Edit the API server pod specification file `/etc/kubernetes/manifests/kubeapiserver.yaml` on the Control Plane node and set the below parameter:\n\n```bash\n--service-account-lookup=true\n```\n\nAlternatively, you can delete the `--service-account-lookup` parameter from this file so that the default takes effect.\n\n**Default Value**\n\nBy default, `--service-account-lookup` argument is set to `true`.\n\n**References**\n\n1. [https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/)\n2. [https://github.com/kubernetes/kubernetes/issues/24167](https://github.com/kubernetes/kubernetes/issues/24167)\n3. [https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use](https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use)",
  "rules": [
    {
      "cloudProviders": [
        "k8s"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "KubernetesPod"
      ],
      "query": "query-k8s-api-server-service-account-lookup"
    }
  ]
}