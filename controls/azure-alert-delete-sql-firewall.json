{
  "name": "Ensure that Activity Log Alert exists for Delete SQL Server Firewall Rule",
  "slug": "azure-alert-delete-sql-firewall",
  "body": "Create an activity log alert for the Delete SQL Server Firewall Rule event.\n\n**Rationale**\n\nMonitoring for Delete Server Firewall Rule events gives insight into network access changes and may reduce the time it takes to detect suspicious activity.\n\n**Impact**\n\nThere will be a substantial increase in log size if there is a large number of administrative actions on a server.",
  "severity": 1,
  "rules": [
    {
      "cloudProviders": [
        "azure"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "CloudAccount"
      ],
      "query": "azure-activity-log-alert-delete-sql-sever"
    }
  ],
  "remediationDescription": "**From Azure Console**\n\n1. Go to `Monitor`\n2. Select `Alerts`\n3. Click on `Create` and select `Alert rule`\n4. Under `Scope`, click `Select scope`\n5. Select the appropriate subscription and click `Apply`\n10. Under `Condition` click `See all signals`\n11. Select the `Delete server firewall rule (Server Firewall Rule)` signal\n12. Click `Apply`\n13. Under `Actions`, click `Select action groups` to pick an existing action group or click `Create action group` and fill in the necessary details to create a new action group\n15. Under `Details`, select the appropriate resource group to save the alert to, and an alert name\n16. Under `Review + create`, check the `Enable upon creation` checkbox\n17. Click `Create`\n\n**Using Azure Command Line Interface**\n\nUse the below command to create an Activity Log Alert for Delete SQL Firewall Rule\n\n```bash\naz monitor activity-log alert create --resource-group \"<resourceGroup>\" --condition category=Administrative and operationName=Microsoft.Sql/servers/firewallRules/delete and level=<verbose | information | warning | error | critical> --scope \"/subscriptions/<subscriptionID>\" --name \"<activityLogRuleName>\" --subscription <subscriptionID> --action-group <actionGroupID> --location global\n```\n\n**Using Azure PowerShell**\n\nCreate the `Conditions` object.\n\n```powershell\n$conditions = @()\n$conditions += New-AzActivityLogAlertAlertRuleAnyOfOrLeafConditionObject -Equal Administrative -Field category\n$conditions += New-AzActivityLogAlertAlertRuleAnyOfOrLeafConditionObject -Equal Microsoft.Sql/servers/firewallRules/delete -Field operationName\n$conditions += New-AzActivityLogAlertAlertRuleAnyOfOrLeafConditionObject -Equal Verbose -Field level\n```\n\nRetrieve the `Action group` information and store it in a variable, then create the `Actions` object.\n\n```powershell\n$actionGroup = Get-AzActionGroup -ResourceGroupName <resourcegroup> -Name <actionGroup>\n$actionObject = New-AzActivityLogAlertActionGroupObject -Id $actionGroup.Id\n```\n\nCreate the `Scope` object.\n\n```powershell\n$scope = \"/subscriptions/<subscriptionID>\"\n```\n\nCreate the `Activity Log Alert Rule` for `Microsoft.Sql/servers/firewallRules/delete`\n\n```powershell\nNew-AzActivityLogAlert -Name \"<activityLogRuleName>\" -ResourceGroupName \"<resourceGroup>\" -Condition $conditions -Scope $scope -Location global -Action $actionObject -Subscription <subscriptionID> -Enabled $true\n```\n\n**Default Value**\n\nBy default, no monitoring alerts are created.\n\n**References**\n\n1. [https://azure.microsoft.com/en-us/updates/classic-alerting-monitoring-retirement](https://azure.microsoft.com/en-us/updates/classic-alerting-monitoring-retirement)\n2. [https://docs.microsoft.com/en-in/azure/azure-monitor/platform/alerts-activity-log](https://docs.microsoft.com/en-in/azure/azure-monitor/platform/alerts-activity-log)\n3. [https://docs.microsoft.com/en-in/rest/api/monitor/activitylogalerts/createorupdate](https://docs.microsoft.com/en-in/rest/api/monitor/activitylogalerts/createorupdate)\n4. [https://docs.microsoft.com/en-in/rest/api/monitor/activitylogalerts/listbysubscriptionid](https://docs.microsoft.com/en-in/rest/api/monitor/activitylogalerts/listbysubscriptionid)\n5. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-3-enable-logging-for-security-investigation](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-3-enable-logging-for-security-investigation)"
}