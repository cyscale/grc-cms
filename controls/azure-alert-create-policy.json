{
  "name": "Ensure that Activity Log Alert exists for Create Policy Assignment",
  "slug": "azure-alert-create-policy",
  "body": "Create an activity log alert for the Create Policy Assignment event.\n\n\r\n**Rationale**\n\n\r\nMonitoring for Create Policy Assignment events gives an insight into changes done in \"Azure policy - assignments\", and can reduce the time it takes to detect unsolicited changes.\r\n",
  "severity": 1,
  "remediationDescription": "**From Azure Console**\n\n1. Navigate to the `Monitor` blade.\n2. Select `Alerts`.\n3. Select `Create`.\n4. Select `Alert Rule`.\n5. Under `Scope`, click `Select scope`.\n6. Select your subscription and click `Apply`.\n7. Select the `Condition` tab.\n8. Under `Signal name`, click `Create policy assignment (Microsoft.Authorization/policyAssignments)`.\n9. Select the `Actions` tab.\n10. Click `Done`.\n11. To use an existing action group, click `Select action groups`. To create a new action group, click `Create action group`. Fill out the appropriate details for the selection.\n12. Select the `Details` tab.\n13. Select a `Resource Group`, provide an `Alert rule name` and an optional `Alert rule description`.\n14. Click `Review + create`.\n15. Click `Create`.\n\n**Using Azure Command Line Interface**\n\nUse the below command to create an Activity Log Alert for `Create policy assignment`\n\n```bash\naz monitor activity-log alert create --resource-group \"<resource group name>\" --condition category=Administrative and operationName=Microsoft.Authorization/policyAssignments/write and level=<verbose | information | warning | error | critical> --scope \"/subscriptions/<subscription ID>\" --name \"<activity log rule name>\" --subscription <subscription ID> --action-group <action group ID>\n```\n\n**Using Azure Powershell**\n\nCreate the `conditions` object.\n\n```powershell\n$conditions = @() \n$conditions += New-AzActivityLogAlertAlertRuleAnyOfOrLeafConditionObject -Equal Administrative -Field category \n$conditions += New-AzActivityLogAlertAlertRuleAnyOfOrLeafConditionObject -Equal Microsoft.Authorization/policyAssignments/write -Field operationName \n$conditions += New-AzActivityLogAlertAlertRuleAnyOfOrLeafConditionObject -Equal Verbose -Field level\n```\n\nGet the `Action Group` information and store it in a variable, then create a new `Action` object.\n\n```powershell\n$actionGroup = Get-AzActionGroup -ResourceGroupName <resource group name> -Name <action group name>\n$actionObject = New-AzActivityLogAlertActionGroupObject -Id $actionGroup.Id\n```\n\nCreate the `scope` variable.\n\n```powershell\n$scope = \"/subscriptions/<subscription ID>\"\n```\n\nCreate the `Activity Log Alert Rule` for `Microsoft.Authorization.policyAssignments/write`.\n\n```powershell\nNew-AzActivityLogAlert -Name \"<activity alert rule name>\" -ResourceGroupName \"<resource group name>\" -Condition $conditions -Scope $scope -Location global -Action $actionObject -Subscription “<subscription ID>” -Enabled $true\n```\n\n**Default Value**\n\nBy default, no monitoring alerts are created.\n\n**References**\n\n1. [https://azure.microsoft.com/en-us/updates/classic-alerting-monitoring-retirement](https://azure.microsoft.com/en-us/updates/classic-alerting-monitoring-retirement)\n2. [https://docs.microsoft.com/en-in/azure/azure-monitor/platform/alerts-activity-log](https://docs.microsoft.com/en-in/azure/azure-monitor/platform/alerts-activity-log)\n3. [https://docs.microsoft.com/en-in/rest/api/monitor/activitylogalerts/createorupdate](https://docs.microsoft.com/en-in/rest/api/monitor/activitylogalerts/createorupdate)\n4. [https://docs.microsoft.com/en-in/rest/api/monitor/activitylogalerts/listbysubscriptionid](https://docs.microsoft.com/en-in/rest/api/monitor/activitylogalerts/listbysubscriptionid)\n5. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-3-enable-logging-for-security-investigation](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-logging-threat-detection#lt-3-enable-logging-for-security-investigation)\n6. [https://docs.microsoft.com/en-in/rest/api/policy/policy-assignments](https://docs.microsoft.com/en-in/rest/api/policy/policy-assignments)\n7. [https://docs.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-log](https://docs.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-log)",
  "rules": [
    {
      "cloudProviders": [
        "azure"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "CloudAccount"
      ],
      "query": "azure-1-3-0-logging-2-1-activity-log-alert-exists-for-create-policy-assignment"
    }
  ]
}