{"name":"Ensure log metric filter and alerts exist for VPC network route changes","slug":"gcp-logging-8","body":"It is recommended that a metric filter and alarm be established for VPC network route changes.\n\n**Rationale**\n\nGoogle Cloud Platform (GCP) routes define the paths network traffic takes from a VM instance to another destinations. The other destination can be inside your VPC network (such as another VM) or outside of it. Every route consists of a destination and a next hop. Traffic whose destination IP is within the destination range is sent to the next hop for delivery.\n\nMonitoring changes to route tables will help ensure that all VPC traffic flows through an expected path.","description":"","severity":1,"remediationDescription":"**From GCP Console, Create prescribed Log Metric**\n\n1. Go to `Logging/Logs` by visiting https://console.cloud.google.com/logs/viewer?\n2. Click down arrow symbol on `Filter Bar` at rightmost corner and select `Convert to Advanced Filter`\n3. This will convert `Filter Bar` to `Advanced Filter Bar`\n4. Clear any text from `Advanced Filter` and add text\n```\nresource.type=\"gce_route\" AND jsonPayload.event_subtype=\"compute.routes.delete\" OR jsonPayload.event_subtype=\"compute.routes.insert\"\n```\n\n5. Click on `Submit Filter` and should display logs based on filter text set in step above\n6. Click `Create Metric` it will open `Metric Export` Menu on right\n7. Configure `Name, Description` to desired values\n8. Set `Units` to 1 (default) and `Type` to `Counter`\n9. Click `Create Metric`. This will take to `Logging/Logs` at https://console.cloud.google.com/logs/metrics?\n\n**From stackdriver Console, Create prescribed Alert Policy**\n\n1. Go to `Logging/Metrics` by visiting https://console.cloud.google.com/logs/metrics?\n2. In section `User-defined Metrics` for target metric, click 3 dot icon in rightmost column to open menu options\n3. Select `Create alert from Metric`.\n4. It will take to `Stackdriver Console\\Alerting\\Create` and directly open `Add Metric Threshold Condition` window\n```\nSet `Target`: `Resource Type` to `Log Metric` Set `Configuration`:\n- IF METRIC : user/\u003cLog Metric Name\u003e\n- Condition : above\n- Threshold: .001\n- For: 1 minute\nSet `Resource` to `ANY`\n```\nClick `Save` Condition\n\n5. It will take back to `Stackdriver Console\\Alerting\\Create`\n6. In Section `2 Notifications` click + `Add Notification`. Add desired channel(s) as required.\n7. In section `3 Documentation` optionally `+ Add Documentation`\n8. In Section `4 Name this policy` leave system provided policy name (Threshold - user/) or configure custom name\n9. Click `Save Policy`. It will open `Alerting/Policies Overview` page which lists all the alert policies including this one.\nFor alert policy Observe Condition which is currently set to\n```\nAny logging.googleapis.com/user/\u003cLog_Metric_Name\u003e is above a threshold of 0.001 for greater than 1 minute\n```\n\nIt is been observed that without following next step, Alert policy will not generate any alerts or open any incidents.\n\n10. For newly created policy, click `EDIT` to Open `Edit alerting Policy` pane\n11. At section 1 Conditions\\Basic Conditions\\suggested condition click `Edit`\n12. In `Target` Section, for `Aggregation` drop down select `count`\n13. Click `save condition` and then click `Save Policy`. It will open `Alerting/Policies Overview`\n\nCondition for same alert policy will be updated to:\n```\nViolates when: Any logging.googleapis.com/user/\u003cLog_Metric_Name\u003e stream is\nabove a threshold of 0.001 for greater than 1 minute\n```\nNow, newly created Alert policy will be able to generate alerts or open incidents.\n\n**Using CLI**\n\nCreate prescribed Log Metric\n\n- Use command: gcloud beta logging metrics create\n- Reference for Command Usage:\nhttps://cloud.google.com/sdk/gcloud/reference/beta/logging/metrics/create \n\nCreate prescribed Alert Policy\n- Use command: gcloud alpha monitoring policies create\n- Reference for command Usage: https://cloud.google.com/sdk/gcloud/reference/alpha/monitoring/policies/create\n\n**Impact**\n\nBased on Service Tiers, Stackdriver account may be charged.\n\n**References**\n\n1. https://cloud.google.com/logging/docs/logs-based-metrics/\n2. https://cloud.google.com/monitoring/custom-metrics/\n3. https://cloud.google.com/monitoring/alerts/\n4. https://cloud.google.com/logging/docs/reference/tools/gcloud-logging\n5. https://cloud.google.com/storage/docs/access-control/iam\n\n**Notes** . \nBefore considering this recommendation Ensure target GCP project is configured with stackdriver account.","rules":[{"cloudProviders":["gcp"],"comparator":"eq","expectedResult":"[]","subjects":["CloudAccount"],"query":"gcp-logging-8-log-metric-filter-and-alerts-exist-for-vpc-network-route-changes","returnPath":""}]}