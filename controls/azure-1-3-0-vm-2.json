{"name":"Ensure that 'OS and Data' disks are encrypted with CMK","slug":"azure-1-3-0-vm-2","body":"Ensure that OS disks (boot volumes) and data disks (non-boot volumes) are encrypted with CMK.\n\n**Rationale**\n\nEncrypting the IaaS VM's OS disk (boot volume), Data disks (non-boot volume) ensures that the entire content is fully unrecoverable without a key and thus protects the volume from unwarranted reads. CMK is superior encryption although requires additional planning.\n\n**Impact: **\n\nUsing CMK/BYOK will entail additional management of keys.\n\n**NOTE** You must have your key vault setup to utilize this.","description":"","severity":2,"remediationDescription":"**From Azure Console**\n\n**Note** Disks must be detached from VMs to have encryption changed.\n\n1. Go to `Virtual machines`\n2. For each virtual machine, go to `Settings`\n3. Click on `Disks`\n4. Click the `X` to detach the disk from the VM\n5. Now search for `Disks` and locate the unattached disk\n6. Click the disk then select `Encryption`\n7. Change your encryption type, then select your encryption set\n8. Click `Save`\n9. Go back to the VM and re-attach the disk\n\n**Using PowerShell**\n\n\u003e`$KVRGname = 'MyKeyVaultResourceGroup';`\n\u003e\n\u003e`$VMRGName = 'MyVirtualMachineResourceGroup';`\n\u003e\n\u003e`$vmName = 'MySecureVM';`\n\u003e\n\u003e`$KeyVaultName = 'MySecureVault';`\n\u003e\n\u003e`$KeyVault = Get-AzKeyVault -VaultName $KeyVaultName -ResourceGroupName $KVRGname;`\n\u003e\n\u003e`$diskEncryptionKeyVaultUrl = $KeyVault.VaultUri;`\n\u003e\n\u003e`$KeyVaultResourceId = $KeyVault.ResourceId;`\n\u003e\n\u003e`Set-AzVMDiskEncryptionExtension -ResourceGroupName $VMRGname -VMName $vmName -DiskEncryptionKeyVaultUrl $diskEncryptionKeyVaultUrl -DiskEncryptionKeyVaultId $KeyVaultResourceId;`\n\n**NOTE** During encryption it is likely that a reboot will be required, it may take up to 15 minutes tocomplete the process.\n\n**NOTE 2** This may differ for Linux Machines as you may need to set the `-skipVmBackup` parameter\n\n**Default Value**\n\nBy default, Azure disks are encrypted using SSE with PMK.\n\n**References**\n\n1. [https://docs.microsoft.com/azure/security/fundamentals/azure-disk-encryption-vms-vmss](https://docs.microsoft.com/azure/security/fundamentals/azure-disk-encryption-vms-vmss)\n2. [https://docs.microsoft.com/en-us/azure/security-center/security-center-disk-encryption?toc=%2fazure%2fsecurity%2ftoc.json](https://docs.microsoft.com/en-us/azure/security-center/security-center-disk-encryption?toc=%2fazure%2fsecurity%2ftoc.json)\n3. [https://docs.microsoft.com/azure/security/fundamentals/data-encryption-best-practices#protect-data-at-rest](https://docs.microsoft.com/azure/security/fundamentals/data-encryption-best-practices#protect-data-at-rest)\n4. [https://docs.microsoft.com/azure/virtual-machines/windows/disk-encryption-portal-quickstart](https://docs.microsoft.com/azure/virtual-machines/windows/disk-encryption-portal-quickstart)\n5. [https://docs.microsoft.com/en-us/rest/api/compute/disks/delete](https://docs.microsoft.com/en-us/rest/api/compute/disks/delete)\n6. [https://docs.microsoft.com/en-us/rest/api/compute/disks/update#encryptionsettings](https://docs.microsoft.com/en-us/rest/api/compute/disks/update#encryptionsettings)\n7. [https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-data-protection#dp-5-encrypt-sensitive-data-at-rest](https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-data-protection#dp-5-encrypt-sensitive-data-at-rest)\n8. [https://docs.microsoft.com/en-us/azure/virtual-machines/windows/disks-enable-customer-managed-keys-powershell](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/disks-enable-customer-managed-keys-powershell)","rules":[{"cloudProviders":["azure"],"comparator":"eq","expectedResult":"[]","subjects":["VM"],"query":"azure-1-3-0-vm-2-os-and-data-disks-are-encrypted-with-cmk","returnPath":""}]}