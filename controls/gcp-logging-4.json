{
  "name": "Ensure log metric filter and alerts exist for Project Ownership assignments/changes",
  "slug": "gcp-logging-4",
  "body": "\nIn order to prevent unnecessary project ownership assignments to users/service accounts and further misuses of projects and resources, all `roles/Owner` assignments should be monitored\n\nMembers (users/service accounts) with role assignment to primitive role `roles/Owner` are project owners.\n\nThe project owner has all the privileges on the project the role belongs to. These are summarized below:\n\n- All viewer permissions on all GCP Services within the project\n- Permissions for actions that modify the state of all GCP services within the project\n- Manage roles and permissions for a project and all resources within the project\n- Set up billing for a project\n\n\nGranting the owner role to a member (user/Service-Account) will allow that member to modify the Identity and Access Management (IAM) policy. Therefore, grant the owner role only if the member has a legitimate purpose to manage the IAM policy. This is because the project IAM policy contains sensitive access control data. Having a minimal set of users allowed to manage IAM policy will simplify any auditing that may be necessary. \r\n\n### Rationale\n\nProject ownership has the highest level of privileges on a project. To avoid misuse of project resources, the project ownership assignment/change actions mentioned above should be monitored and alerted to concerned recipients.\n\n- Sending project ownership invites\n- Acceptance/Rejection of project ownership invite by user\n- Adding `roles/Owner` to a user/service account\n- Removing a user/service account from `roles/owner`\n",
  "description": "",
  "severity": 1,
  "remediationDescription": "### From Console\n\n\r\n\r\nCreate the prescribed log metric:\r\n\r\n1. Go to `Logging/Logs-based Metrics` by visiting [https://console.cloud.google.com/logs/metrics](https://console.cloud.google.com/logs/metrics) and click \"CREATE METRIC\".\r\n2. Click the down arrow symbol on the `Filter Bar` at the rightmost corner and select `Convert to Advanced Filter`.\r\n3. Clear any text and add:\n\n\r\n\r\n```bash\r\n(protoPayload.serviceName=\"cloudresourcemanager.googleapis.com\")\r\nAND (ProjectOwnership OR projectOwnerInvitee)\r\nOR (protoPayload.serviceData.policyDelta.bindingDeltas.action=\"REMOVE\"\r\nAND protoPayload.serviceData.policyDelta.bindingDeltas.role=\"roles/owner\") OR (protoPayload.serviceData.policyDelta.bindingDeltas.action=\"ADD\"\r\nAND protoPayload.serviceData.policyDelta.bindingDeltas.role=\"roles/owner\")\r\n```\r\n\r\n4. Click `Submit Filter`. The logs display based on the filter text entered by the user.\r\n5. In the `Metric Editor` menu on the right, fill out the name field. Set `Units` to `1`(default) and the `Type` to `Counter`. This ensures that the log metric counts the number of log entries matching the advanced logs query.\r\n6. Click `Create Metric`.\n\n\r\n\r\n#### Create the display prescribed Alert Policy:\n\n\r\n\r\n1. Identify the newly created metric under the section `User-defined Metrics` at [https://console.cloud.google.com/logs/metrics](https://console.cloud.google.com/logs/metrics).\r\n2. Click the 3-dot icon in the rightmost column for the desired metric and select `Create alert from Metric`. A new page opens.\r\n3. Fill out the alert policy configuration and click `Save`. Choose the alerting threshold and configuration that makes sense for the user's organization. For example, a threshold of zero (0) for the most recent value will ensure that a notification is triggered for every owner change in the project:\r\n\r\n```bash\r\nSet `Aggregator` to `Count`\r\nSet `Configuration`:\r\n- Condition: above\r\n- Threshold: 0\r\n- For: most recent value\r\n```\r\n\r\n4. Configure the desired notifications channels in the section `Notifications`.\r\n5. Name the policy and click `Save`.\n\n\r\n\r\n### From Command Line\n\n\r\n\r\nCreate a prescribed Log Metric:\r\n\r\n- Use the command: gcloud beta logging metrics create.\r\n- Reference for Command Usage: [https://cloud.google.com/sdk/gcloud/reference/beta/logging/metrics/create](https://cloud.google.com/sdk/gcloud/reference/beta/logging/metrics/create).\r\n\r\nCreate a prescribed Alert Policy:\r\n\r\n- Use the command: gcloud alpha monitoring policies create.\r\n- Reference for Command Usage: [https://cloud.google.com/sdk/gcloud/reference/alpha/monitoring/policies/create](https://cloud.google.com/sdk/gcloud/reference/alpha/monitoring/policies/create).\r\n\n### Additional Information\n\n1. Project ownership assignments for a user cannot be done using the gcloud utility as assigning project ownership to a user requires sending, and the user accepting, an invitation.\n2. Project Ownership assignment to a service account does not send any invites. `SetIAMPolicy` to `roles/owner` is directly performed on service accounts.",
  "rules": [
    {
      "cloudProviders": [
        "gcp"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "CloudAccount"
      ],
      "query": "gcp-logging-4-log-metric-filter-and-alerts-exist-for-project-ownership-assignmentschanges",
      "returnPath": ""
    }
  ],
  "alertForSecondaryOnly": false
}