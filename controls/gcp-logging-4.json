{
  "name": "Ensure log metric filter and alerts exist for Project Ownership assignments/changes",
  "slug": "gcp-logging-4",
  "body": "\nIn order to prevent unnecessary project ownership assignments to users/serviceaccounts and further misuses of projects and resources, all `roles/Owner` assignments should be monitored\n\nMembers (users/service accounts) with role assignment to primitive role `roles/Owner` are project owners.\n\nThe project owner has all the privileges on the project the role belongs to. These are summarized below:\n```\n- All viewer permissions on all GCP Services within the project\n- Permissions for actions that modify the state of all GCP services within the project\n- Manage roles and permissions for a project and all resources within the project\n- Set up billing for a project\n```\n\nGranting the owner role to a member (user/Service-Account) will allow that member to modify the Identity and Access Management (IAM) policy. Therefore, grant the owner role only if the member has a legitimate purpose to manage the IAM policy. This is because the project IAM policy contains sensitive access control data. Having a minimal set of users allowed to manage IAM policy will simplify any auditing that may be necessary. \r\n\n**Rationale**\n\nProject ownership has the highest level of privileges on a project. To avoid misuse of project resources, the project ownership assignment/change actions mentioned above should be monitored and alerted to concerned recipients.\n\n- Sending project ownership invites\n- Acceptance/Rejection of project ownership invite by user\n- Adding `roles/Owner` to a user/service account\n- Removing a user/service account from `roles/owner`\n",
  "description": "",
  "severity": 1,
  "remediationDescription": "**From GCP Console, Create prescribed Log Metric**\n\n1. Go to `Logging/Logs` by visiting https://console.cloud.google.com/logs/viewer?\n2. Click down arrow symbol on `Filter Bar` at rightmost corner and select `Convert to Advanced Filter`\n3. This will convert `Filter Bar` to `Advanced Filter Bar`\n4. Clear any text from `Advanced Filter` and add text\n```\n(protoPayload.serviceName=\"cloudresourcemanager.googleapis.com\") AND (ProjectOwnership OR projectOwnerInvitee) OR (protoPayload.serviceData.policyDelta.bindingDeltas.action=\"REMOVE\" AND protoPayload.serviceData.policyDelta.bindingDeltas.role=\"roles/owner\") OR (protoPayload.serviceData.policyDelta.bindingDeltas.action=\"ADD\" AND protoPayload.serviceData.policyDelta.bindingDeltas.role=\"roles/owner\")\n```\n\n5. Click on `Submit Filter` and should display logs based on filter text set in step above\n6. Click `Create Metric` it will open `Metric Export` Menu on right\n7. Configure `Name, Description` to desired values\n8. Set `Units` to 1 (default) and `Type` to `Counter`\n9. Click `Create Metric`. This will take to `Logging/Logs` at https://console.cloud.google.com/logs/metrics?\n\n**From stackdriver Console, Create prescribed Alert Policy**\n\n1. Go to `Logging/Metrics` by visiting https://console.cloud.google.com/logs/metrics?\n2. In section `User-defined Metrics` for target metric, click 3 dot icon in rightmost column to open menu options\n3. Select `Create alert from Metric`.\n4. It will take to `Stackdriver Console\\Alerting\\Create` and directly open `Add Metric Threshold Condition` window\n```\nSet `Target`: `Resource Type` to `Log Metric` Set `Configuration`:\n- IF METRIC : user/<Log Metric Name>\n- Condition : above\n- Threshold: .001\n- For: 1 minute\nSet `Resource` to `ANY`\n```\nClick `Save` Condition\n\n5. It will take back to `Stackdriver Console\\Alerting\\Create`\n6. In Section `2 Notifications` click + `Add Notification`. Add desired channel(s) as required.\n7. In section `3 Documentation` optionally `+ Add Documentation`\n8. In Section `4 Name this policy` leave system provided policy name (Threshold - user/) or configure custom name\n9. Click `Save Policy`. It will open `Alerting/Policies Overview` page which lists all the alert policies including this one.\nFor alert policy Observe Condition which is currently set to\n```\nAny logging.googleapis.com/user/<Log_Metric_Name> is above a threshold of 0.001 for greater than 1 minute\n```\n\nIt is been observed that without following next step, Alert policy will not generate any alerts or open any incidents.\n\n10. For newly created policy, click `EDIT` to Open `Edit alerting Policy` pane\n11. At section 1 Conditions\\Basic Conditions\\suggested condition click `Edit`\n12. In `Target` Section, for `Aggregation` drop down select `count`\n13. Click `save condition` and then click `Save Policy`. It will open `Alerting/Policies Overview`\n\nCondition for same alert policy will be updated to:\n```\nViolates when: Any logging.googleapis.com/user/<Log_Metric_Name> stream is above a threshold of 0.001 for greater than 1 minute\n```\n\n**Using CLI**\n\nCreate prescribed Log Metric\n\n- Use command: gcloud beta logging metrics create\n- Reference for Command Usage:\nhttps://cloud.google.com/sdk/gcloud/reference/beta/logging/metrics/create \n\nCreate prescribed Alert Policy\n- Use command: gcloud alpha monitoring policies create\n- Reference for command Usage: https://cloud.google.com/sdk/gcloud/reference/alpha/monitoring/policies/create\n\n**Impact**\n\nBased on Service Tiers, Stackdriver account may be charged.\n\n**References**\n\n1. https://cloud.google.com/logging/docs/logs-based-metrics/\n2. https://cloud.google.com/monitoring/custom-metrics/\n3. https://cloud.google.com/monitoring/alerts/\n4. https://cloud.google.com/logging/docs/reference/tools/gcloud-logging\n\n**Notes**\n\n1. Before considering this recommendation Ensure target GCP project is configured with stackdriver account\n2. Project Ownership assignments for a user cannot be done using gcloud utility as setting project ownership to a user requires sending and accepting invite\n3. Project Ownership assignment to a service account does not sends any invites. SetIAMPolicy to `roles/owner` is directly performed on service accounts",
  "rules": [
    {
      "cloudProviders": [
        "gcp"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "CloudAccount"
      ],
      "query": "gcp-logging-4-log-metric-filter-and-alerts-exist-for-project-ownership-assignmentschanges",
      "returnPath": ""
    }
  ],
  "alertForSecondaryOnly": false
}