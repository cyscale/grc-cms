{
  "slug": "azure-defender-endpoint-selected",
  "name": "Ensure that Microsoft Defender for Endpoint integration with Microsoft Defender for Cloud is selected",
  "description": "Microsoft Defender for Endpoint integration is not selected.",
  "body": "This integration setting enables Microsoft Defender for Endpoint (formerly 'Advanced Threat Protection' or 'ATP' or 'WDATP') to communicate with Microsoft Defender for Cloud.\n\n**Rationale**\n\nMicrosoft Defender for Endpoint integration brings comprehensive Endpoint Detection and Response (EDR) capabilities within Microsoft Defender for Cloud. This integration helps to spot abnormalities, as well as detect and respond to advanced attacks on endpoints monitored by Microsoft Defender for Cloud.\n\nMicrosoft Defender for Endpoint works only with Standard Tier subscriptions.\n\n\n**Impact**\n\nMicrosoft Defender for Endpoint works with Standard pricing tier Subscription. Choosing the Standard pricing tier of Microsoft Defender for Cloud incurs an additional cost per resource.\n\n**Additional information**\n\nIMPORTANT: When enabling integration between Defender for Endpoint & Defender for Cloud, you need to take into account that this will have some side effects that may be undesirable:\n1. For server 2019 and above, if Defender is installed (default for these server SKU's), this will trigger a deployment of the new unified agent and link to any of the extended configuration in the Defender portal.\n2. If the new unified agent is required for server SKU's of Windows 2016 or Linux and lower there is an additional integration that needs to be switched on and agents need to be aligned.",
  "severity": 1,
  "remediationDescription": "**From Azure Console**\n\n1. Go to `Microsoft Defender for Cloud`\n2. Select the `Environment Settings` blade\n3. Select the subscription\n4. Select `Integrations`\n5. Check `Allow Windows Defender for Endpoint to access my data`\n6. Select `Save`\n\n**Using Azure Command Line Interface**\n\nUse the below command to enable Standard pricing tier for Storage Accounts\n\n```bash\naz account get-access-token --query \"{subscription:subscription,accessToken:accessToken}\" --out tsv | xargs -L1 bash -c 'curl -X PUT -H \"Authorization: Bearer $1\" -H \"Content-Type: application/json\" https://management.azure.com/subscriptions/<subscriptionID>/providers/Microsoft.Security/settings/WDATP?api-version=2021-06-01 -d@\"input.json\"'\n```\n\nWhere input.json contains the Request body json data as mentioned below.\n\n```json\n{\n    \"id\": \"/subscriptions/<subscription ID>/providers/Microsoft.Security/settings/WDATP\",\n    \"kind\": \"DataExportSetting\",\n    \"type\": \"Microsoft.Security/settings\",\n    \"properties\": {\n        \"enabled\": true\n    }\n}\n```\n\n**References**\n\n1. [https://docs.microsoft.com/en-in/azure/defender-for-cloud/integration-defender-for-endpoint?tabs=windows](https://docs.microsoft.com/en-in/azure/defender-for-cloud/integration-defender-for-endpoint?tabs=windows)\n2. [https://docs.microsoft.com/en-us/rest/api/securitycenter/settings/list](https://docs.microsoft.com/en-us/rest/api/securitycenter/settings/list)\n3. [https://docs.microsoft.com/en-us/rest/api/securitycenter/settings/update](https://docs.microsoft.com/en-us/rest/api/securitycenter/settings/update)\n4. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-endpoint-security#es-1-use-endpoint-detection-and-response-edr](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-endpoint-security#es-1-use-endpoint-detection-and-response-edr)\n5. [https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-endpoint-security#es-2-use-modern-anti-malware-software](https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-endpoint-security#es-2-use-modern-anti-malware-software)",
  "rules": [
    {
      "cloudProviders": [
        "azure"
      ],
      "comparator": "eq",
      "expectedResult": "[]",
      "subjects": [
        "CloudAccount"
      ],
      "query": "azure-iam-account-summaries-with-wdapt-enabled"
    }
  ]
}