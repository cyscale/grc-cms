{"name":"Ensure no Azure SQL Databases allow ingress from 0.0.0.0/0 (ANY IP)","slug":"azure-1-3-0-networking-3","body":"Ensure that no SQL Databases allow ingress from 0.0.0.0/0 (ANY IP).\n\n**Rationale**\n\nSQL Server includes a firewall to block access to unauthorized connections. More granular IP addresses can be defined by referencing the range of addresses available from specific datacenters.By default, for a SQL server, a Firewall exists with StartIp of 0.0.0.0 and EndIP of 0.0.0.0 allowing access to all the Azure services.Additionally, a custom rule can be set up with StartIp of 0.0.0.0 and EndIP of 255.255.255.255 allowing access from ANY IP over the Internet.In order to reduce the potential attack surface for a SQL server, firewall rules should be defined with more granular IP addresses by referencing the range of addresses available from specific datacenters.\n\n**Impact: **\n\nDisabling Allow access to Azure Serviceswill break all connections to SQL server and Hosted Databases unless custom IP specific rules are not added in Firewall Policy.","description":"","severity":3,"remediationDescription":"**From Azure Console**\n\n1. Go to `SQL servers`\n2. For each SQL server\n3. Click on `Firewall / Virtual Networks`\n4. Set `Allow access to Azure services` to `OFF'\n5. Set firewall rules to limit access to only authorized connections\n\nUsing Azure PowerShell\nDisable Default Firewall Rule `Allow access to Azure services`:\n\n`Remove-AzureRmSqlServerFirewallRule -FirewallRuleName \"AllowAllWindowsAzureIps\" -ResourceGroupName \u003cresource group name\u003e -ServerName \u003cserver name\u003e`\n\nRemove custom Firewall rule:\n\n`Remove-AzureRmSqlServerFirewallRule -FirewallRuleName \"\u003cfirewallRuleName\u003e\" -ResourceGroupName \u003cresource group name\u003e -ServerName \u003cserver name\u003e`\n\nSet the appropriate firewall rules:\n\n\u003e`Set-AzureRmSqlServerFirewallRule -ResourceGroupName \u003cresource group name\u003e -ServerName \u003cserver name\u003e -FirewallRuleName \"\u003cFw rule Name\u003e\" -StartIpAddress \"\u003cIP Address other than 0.0.0.0\u003e\" -EndIpAddress \"\u003cIP Address other than 0.0.0.0 or 255.255.255.255\u003e\"`\n\n**Default Value**\n\nBy default, setting `Allow access to Azure Services` is set to `ON` allowing access to all Windows Azure IP ranges.\n\n**References**\n\n1. [https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access?view=sql-server-2017](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access?view=sql-server-2017)\n2. [https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/get-azurermsqlserverfirewallrule?view=azurermps-5.2.0](https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/get-azurermsqlserverfirewallrule?view=azurermps-5.2.0)\n3. [https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/set-azurermsqlserverfirewallrule?view=azurermps-5.2.0](https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/set-azurermsqlserverfirewallrule?view=azurermps-5.2.0)\n4. [https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/remove-azurermsqlserverfirewallrule?view=azurermps-5.2.0](https://docs.microsoft.com/en-us/powershell/module/azurerm.sql/remove-azurermsqlserverfirewallrule?view=azurermps-5.2.0)\n5. [https://docs.microsoft.com/en-us/azure/sql-database/sql-database-firewall-configure]https://docs.microsoft.com/en-us/azure/sql-database/sql-database-firewall-configure()\n6. [https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-set-database-firewall-rule-azure-sql-database?view=azuresqldb-current](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-set-database-firewall-rule-azure-sql-database?view=azuresqldb-current)\n7. [https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-network-security#ns-1-implement-security-for-internal-traffic](https://docs.microsoft.com/en-us/azure/security/benchmarks/security-controls-v2-network-security#ns-1-implement-security-for-internal-traffic)\n\n**Additional Information**\n\nFirewall rules configured on individual SQL Database using Transact-sql overrides the rules set on SQL server. Azure does not provides any Powershell, API, CLI, Portal option to check database level firewall rules and so far Transact-SQL is the only way to check for the same. For comprehensive control over egress traffic on SQL Databases, Firewall rules should be checked using SQL client.","rules":[{"cloudProviders":["azure"],"comparator":"eq","expectedResult":"[]","subjects":["SQLServer"],"query":"azure-1-3-0-networking-3-no-azure-sql-databases-allow-ingress-from-0-0-0-00-any-ip","returnPath":""}]}